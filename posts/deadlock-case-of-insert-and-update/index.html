<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css><link rel=icon href=/favicon.ico><title>~/on-the-road</title>
<meta charset=utf-8><meta name=description content="Ladder@I find a deadlock case of update &mldr;"><meta name=author content="leo9827"><link rel=canonical href=https://leo9827.github.io/posts/deadlock-case-of-insert-and-update/><link rel=stylesheet href=/css/main.min.8fdbbc58b1127d24d69251880ba35cc81962e25a734d04a4318c766e02b6f382.css integrity="sha256-j9u8WLESfSTWklGIC6NcyBli4lpzTQSkMYx2bgK284I=" crossorigin=anonymous media=screen><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js></script></head><script>pangu.spacingElementById("main"),pangu.spacingElementByClassName("comment"),pangu.spacingElementByTagName("p"),document.addEventListener("DOMContentLoaded",()=>{pangu.autoSpacingPage()}),document.addEventListener("DOMContentLoaded",function(){const s=document.querySelectorAll(".post-card-summary"),t=140;s.forEach(e=>{console.log(e.textContent.length),e.textContent.length>t&&(e.textContent=e.textContent.substring(0,t-1)+" ...")});const n=document.querySelector(".theme-switch"),o='<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>',i='<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>';let e=!1;const a=localStorage.getItem("theme")||"light";a==="dark"&&document.body.classList.add("dark-mode"),n.addEventListener("click",()=>{document.body.classList.toggle("dark-mode"),e=!e,n.innerHTML=`${e?i:o}`;let t="light";document.body.classList.contains("dark-mode")&&(t="dark"),localStorage.setItem("theme",t)});const r=document.querySelectorAll(".post");r.forEach(e=>{const t=e.querySelectorAll("table");t.forEach(e=>{const t=document.createElement("div");t.classList.add("table-container"),e.parentNode.insertBefore(t,e),t.appendChild(e)})})})</script><body><header id=header-main class=header-main><div class=header-inner><div class=header-brand><a href=/>~/</a></div><nav class=header-nav><ul><li><a href=/posts>Posts</a></li><li><a href=/archives>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav><div class=header-social-icons><a href=#><i class="fab fa-github"></i></a>
<a href=#><i class="fab fa-twitter"></i></a>
<a href=#><i class="fas fa-envelope"></i></a>
<button class=theme-switch><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg></button></div></div></header><main class=wrapper><div id=post class=post><article class=post-single><header class=post-title><h1>Deadlock case of insert and update</h1></header><p><small>Post on&nbsp;December 6, 2023&nbsp;
·&nbsp;16303 words&nbsp;
·&nbsp;reading time 12 min</small><p><div class=post-toc><nav id=TableOfContents><ul><li><a href=#参考资料>参考资料</a></li></ul></nav><br></div><section class=post-content><p>I find a deadlock case of update &mldr;</p><p>场景：
事务1在批量 <code>insert</code> 时，事务2尝试锁定读取，此时事务1再锁定读取，事务2会得到输出 <code>Deadlock</code>
事务2 锁定读取的 <code>where</code> 条件和 事务1完全无关，且这条数据已经存在。</p><p>创建 table</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>tb</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>_id</span><span class=w>  </span><span class=nb>bigint</span><span class=w> </span><span class=n>auto_increment</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>id</span><span class=w>  </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>pid</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;01&#39;</span><span class=p>);</span><span class=w> </span><span class=o>#</span><span class=w> </span><span class=err>提前插入一行数据</span><span class=w>
</span></span></span></code></pre></div><p>这里重点是：</p><p>1.<code>id</code> 列没有索引，整个表只有<code>primary key</code></p><p>2.表中已经<code>insert</code> 过部分数据，事务2尝试锁定并修改这些已经 <code>insert</code> 的数据</p><p>3.事务1尝试 <code>insert</code> 新的数据，并尝试锁定新数据后修改</p><p>4.事务2要锁定数据的 <code>where</code> 条件和 事务1完全无关</p><p>修复方法：</p><p>1.在 <code>id</code> 这列新增一个索引 <code>alter table tb add index index(id);</code>，死锁则不存在。</p><p>复现路径</p><p>Session 1</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;11&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;12&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;13&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;14&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;15&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;16&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;17&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;18&#39;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pid-01&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>commit</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Session 2</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pid-11&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>commit</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>执行顺序：</p><p>1 Session 1 执行 <code>start</code> 和 <code>insert</code> 然后暂停</p><p>2 Session 2 执行 <code>start</code> 和 <code>select for update</code></p><p>此时 Session2 出现阻塞：</p><p><code>innoDB</code> 中的 <code>information_schema.innodb_lock</code> 会有如下记录:</p><table><thead><tr><th>lock_id</th><th>lock_trx_id</th><th>lock_mode</th><th>lock_type</th><th>lock_table</th><th>lock_index</th><th>lock_space</th><th>lock_page</th><th>lock_rec</th><th>lock_data</th></tr></thead><tbody><tr><td>31206760200:2515:3:2</td><td>31206760200</td><td>X</td><td>RECORD</td><td>tb</td><td>PRIMARY</td><td>2515</td><td>3</td><td>2</td><td>33</td></tr><tr><td>31206760140:2515:3:2</td><td>31206760140</td><td>X</td><td>RECORD</td><td>tb</td><td>PRIMARY</td><td>2515</td><td>3</td><td>2</td><td>33</td></tr></tbody></table><p>此时再执行 Session 1 中的 <code>select for update</code> ，可以执行成功，</p><p>但同时 Session 2 会得到如下结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>&gt; select * from tb where id = &#39;08:c0:eb:71:fb:81&#39; for update  
</span></span><span class=line><span class=cl>[2023-12-14 18:00:50] 0 rows retrieved in 1 m 37 s 905 ms (execution: 1 m 37 s 897 ms, fetching: 8 ms)  
</span></span><span class=line><span class=cl>[2023-12-14 18:00:50] [40001][1213] Deadlock found when trying to get lock; try restarting transaction
</span></span></code></pre></div><p>说明 Session 1 的成功是在主动回滚 Session 2 产生的结果.</p><p>使用 <code>show engine innodb status</code> 查看 <code>monitor output</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>------------------------  
</span></span><span class=line><span class=cl>LATEST DETECTED DEADLOCK  
</span></span><span class=line><span class=cl>------------------------  
</span></span><span class=line><span class=cl>2023-12-14 18:23:57 0x7f511d16d700  
</span></span><span class=line><span class=cl>*** (1) TRANSACTION:  
</span></span><span class=line><span class=cl>TRANSACTION 31206763612, ACTIVE 5 sec fetching rows  
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1  
</span></span><span class=line><span class=cl>LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)  
</span></span><span class=line><span class=cl>MySQL thread id 4152046, OS thread handle 139986358712064, query id 2055817203 10.226.143.197 root Sending data  
</span></span><span class=line><span class=cl>select * from tb where id = &#39;71:c0:eb:08:fb:81&#39; for update  
</span></span><span class=line><span class=cl>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763612 lock_mode X locks rec but not gap waiting  
</span></span><span class=line><span class=cl>Record lock, heap no 66 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000041; asc        A;;  
</span></span><span class=line><span class=cl> 1: len 6; hex 000744116c54; asc   D lT;;  
</span></span><span class=line><span class=cl> 2: len 7; hex c2000005e70110; asc        ;;  
</span></span><span class=line><span class=cl> 3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl> 4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>*** (2) TRANSACTION:  
</span></span><span class=line><span class=cl>TRANSACTION 31206763604, ACTIVE 10 sec fetching rows, thread declared inside InnoDB 4952  
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1  
</span></span><span class=line><span class=cl>3 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 8  
</span></span><span class=line><span class=cl>MySQL thread id 4151727, OS thread handle 139986357114624, query id 2055819469 10.226.143.197 root Sending data  
</span></span><span class=line><span class=cl>select * from tb where id = &#39;72:c0:eb:08:fb:81&#39; for update  
</span></span><span class=line><span class=cl>*** (2) HOLDS THE LOCK(S):  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763604 lock_mode X locks rec but not gap  
</span></span><span class=line><span class=cl>Record lock, heap no 50 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000029; asc        );;  
</span></span><span class=line><span class=cl> 1: len 6; hex 0007441169d3; asc   D i ;;  
</span></span><span class=line><span class=cl> 2: len 7; hex 7d000002dd2a40; asc }    *@;;  
</span></span><span class=line><span class=cl> 3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl> 4: len 7; hex 7069642d313233; asc pid-123;;  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>Record lock, heap no 66 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000041; asc        A;;  
</span></span><span class=line><span class=cl> 1: len 6; hex 000744116c54; asc   D lT;;  
</span></span><span class=line><span class=cl> 2: len 7; hex c2000005e70110; asc        ;;  
</span></span><span class=line><span class=cl> 3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl> 4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763604 lock_mode X locks rec but not gap waiting  
</span></span><span class=line><span class=cl>Record lock, heap no 42 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000031; asc        1;;  
</span></span><span class=line><span class=cl> 1: len 6; hex 000744116ac9; asc   D j ;;  
</span></span><span class=line><span class=cl> 2: len 7; hex db0001b5810110; asc        ;;  
</span></span><span class=line><span class=cl> 3: len 17; hex 37313a63303a65623a30383a66623a3831; asc 71:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl> 4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>*** WE ROLL BACK TRANSACTION (1)
</span></span></code></pre></div><p>死锁前开启<code>deadlock log</code> 便于查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>set</span><span class=w> </span><span class=k>global</span><span class=w> </span><span class=n>innodb_print_all_deadlocks</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>得到的 mysql deadlock log</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>2023-12-14T10:23:57.105902Z 4151727 [Note] InnoDB: Transactions deadlock detected, dumping detailed information.  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.105934Z 4151727 [Note] InnoDB:  
</span></span><span class=line><span class=cl>*** (1) TRANSACTION:  
</span></span><span class=line><span class=cl>TRANSACTION 31206763612, ACTIVE 5 sec fetching rows  
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1  
</span></span><span class=line><span class=cl>LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)  
</span></span><span class=line><span class=cl>MySQL thread id 4152046, OS thread handle 139986358712064, query id 2055817203 10.226.143.197 root Sending data  
</span></span><span class=line><span class=cl>select * from tb where id = &#39;71:c0:eb:08:fb:81&#39; for update  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.105987Z 4151727 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED:  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763612 lock_mode X locks rec but not gap waiting  
</span></span><span class=line><span class=cl>Record lock, heap no 66 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl>0: len 8; hex 8000000000000041; asc        A;;  
</span></span><span class=line><span class=cl>1: len 6; hex 000744116c54; asc   D lT;;  
</span></span><span class=line><span class=cl>2: len 7; hex c2000005e70110; asc        ;;  
</span></span><span class=line><span class=cl>3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl>4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.106234Z 4151727 [Note] InnoDB: *** (2) TRANSACTION:  
</span></span><span class=line><span class=cl>TRANSACTION 31206763604, ACTIVE 10 sec fetching rows, thread declared inside InnoDB 4952  
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1  
</span></span><span class=line><span class=cl>3 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 8  
</span></span><span class=line><span class=cl>MySQL thread id 4151727, OS thread handle 139986357114624, query id 2055819469 10.226.143.197 root Sending data  
</span></span><span class=line><span class=cl>select * from tb where id = &#39;72:c0:eb:08:fb:81&#39; for update  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.106296Z 4151727 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763604 lock_mode X locks rec but not gap  
</span></span><span class=line><span class=cl>Record lock, heap no 50 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl>0: len 8; hex 8000000000000029; asc        );;  
</span></span><span class=line><span class=cl>1: len 6; hex 0007441169d3; asc   D i ;;  
</span></span><span class=line><span class=cl>2: len 7; hex 7d000002dd2a40; asc }    *@;;  
</span></span><span class=line><span class=cl>3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl>4: len 7; hex 7069642d313233; asc pid-123;;  
</span></span><span class=line><span class=cl>Record lock, heap no 66 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl>0: len 8; hex 8000000000000041; asc        A;;  
</span></span><span class=line><span class=cl>1: len 6; hex 000744116c54; asc   D lT;;  
</span></span><span class=line><span class=cl>2: len 7; hex c2000005e70110; asc        ;;  
</span></span><span class=line><span class=cl>3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl>4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.106740Z 4151727 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:  
</span></span><span class=line><span class=cl>RECORD LOCKS space id 2515 page no 3 n bits 144 index PRIMARY of table `cc`.`tb` trx id 31206763604 lock_mode X locks rec but not gap waiting  
</span></span><span class=line><span class=cl>Record lock, heap no 42 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  
</span></span><span class=line><span class=cl>0: len 8; hex 8000000000000031; asc        1;;  
</span></span><span class=line><span class=cl>1: len 6; hex 000744116ac9; asc   D j ;;  
</span></span><span class=line><span class=cl>2: len 7; hex db0001b5810110; asc        ;;  
</span></span><span class=line><span class=cl>3: len 17; hex 37313a63303a65623a30383a66623a3831; asc 71:c0:eb:08:fb:81;;  
</span></span><span class=line><span class=cl>4: len 0; hex ; asc ;;  
</span></span><span class=line><span class=cl>2023-12-14T10:23:57.107014Z 4151727 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1)  
</span></span></code></pre></div><p>另一种情况:</p><p>Session 1 执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Session 2 执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;11&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;12&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;13&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;14&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;15&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;16&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;17&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=s1>&#39;18&#39;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>此时 Session 2 的 <code>select for update</code> 会被阻塞</p><p>Session 1 再执行 <code>update</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pid-01&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>此时， Session 1 执行结果是： <code>[1213] Deadlock found when trying to get lock; try restarting transaction</code>。</p><p>monitor output</p><pre tabindex=0><code>------------------------
LATEST DETECTED DEADLOCK
------------------------
2023-12-15 09:50:10 0x7f511e2b1700
*** (1) TRANSACTION:
TRANSACTION 31206907203, ACTIVE 4 sec fetching rows
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 8
MySQL thread id 4203196, OS thread handle 139986374153984, query id 2076181314 10.226.143.197 root Sending data
select * from tb where id = &#39;72:c0:eb:08:fb:81&#39; for update
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 2515 page no 3 n bits 176 index PRIMARY of table `cc`.`tb` trx id 31206907203 lock_mode X locks rec but not gap waiting
Record lock, heap no 42 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 8; hex 8000000000000031; asc        1;;
 1: len 6; hex 000744116ac9; asc   D j ;;
 2: len 7; hex db0001b5810110; asc        ;;
 3: len 17; hex 37313a63303a65623a30383a66623a3831; asc 71:c0:eb:08:fb:81;;
 4: len 0; hex ; asc ;;

*** (2) TRANSACTION:
TRANSACTION 31206907182, ACTIVE 12 sec fetching rows, thread declared inside InnoDB 4960
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 4203200, OS thread handle 139986375218944, query id 2076184122 10.226.143.197 root updating
update tb set pid = &#39;pid-123&#39; where id = &#39;71:c0:eb:08:fb:81&#39;
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 2515 page no 3 n bits 168 index PRIMARY of table `cc`.`tb` trx id 31206907182 lock_mode X locks rec but not gap
Record lock, heap no 42 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 8; hex 8000000000000031; asc        1;;
 1: len 6; hex 000744116ac9; asc   D j ;;
 2: len 7; hex db0001b5810110; asc        ;;
 3: len 17; hex 37313a63303a65623a30383a66623a3831; asc 71:c0:eb:08:fb:81;;
 4: len 0; hex ; asc ;;

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 2515 page no 3 n bits 176 index PRIMARY of table `cc`.`tb` trx id 31206907182 lock_mode X locks rec but not gap waiting
Record lock, heap no 50 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 8; hex 8000000000000029; asc        );;
 1: len 6; hex 0007441169d3; asc   D i ;;
 2: len 7; hex 7d000002dd2a40; asc }    *@;;
 3: len 17; hex 37323a63303a65623a30383a66623a3831; asc 72:c0:eb:08:fb:81;;
 4: len 7; hex 7069642d313233; asc pid-123;;

*** WE ROLL BACK TRANSACTION (2)
</code></pre><p>排除是 <code>auto-increment</code> 相关的 <code>AUTO-INC</code> 表级锁问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>tb</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>  </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pid</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;02&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;03&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;04&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;05&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;06&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;07&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;08&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>TX1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>  
</span></span></span></code></pre></div><p>TX2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>11</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;12&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>13</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;13&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>14</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;14&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;15&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;16&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>17</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;17&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>18</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;18&#39;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>阻塞在 <code>select for update</code></p><p>TX1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pid-123&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=p>[</span><span class=mi>40001</span><span class=p>][</span><span class=mi>1213</span><span class=p>]</span><span class=w> </span><span class=n>Deadlock</span><span class=w> </span><span class=k>found</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>trying</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=k>lock</span><span class=p>;</span><span class=w> </span><span class=n>try</span><span class=w> </span><span class=n>restarting</span><span class=w> </span><span class=k>transaction</span><span class=w>
</span></span></span></code></pre></div><p>得到同样的结果</p><p>锁范围确认
Tx1</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;04&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Tx2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w> </span><span class=o>#</span><span class=w> </span><span class=err>等待</span><span class=w> </span><span class=n>_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>Record</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=err>锁</span><span class=w> </span><span class=err>释放</span><span class=w>  
</span></span></span></code></pre></div><p>Tx3</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;05&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w> </span><span class=o>#</span><span class=w> </span><span class=err>同样需要等待</span><span class=w> </span><span class=n>_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>Record</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=err>锁</span><span class=w> </span><span class=err>释放</span><span class=w>  
</span></span></span></code></pre></div><p>由此可见整个 table 都被 lock 住。</p><p>尝试复现</p><p>表锁.
简化后的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>tb</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>  </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pid</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>TX1：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>TX2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>11</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;12&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>13</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;13&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>14</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;14&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;15&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;16&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>17</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;17&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>18</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;18&#39;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>此时 <code>select for update</code> 阻塞住</p><p>Tx1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>第二次执行</span><span class=p>,</span><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=err>无论存在还是不存在都一样</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;01&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;91&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=p>[</span><span class=mi>40001</span><span class=p>][</span><span class=mi>1213</span><span class=p>]</span><span class=w> </span><span class=n>Deadlock</span><span class=w> </span><span class=k>found</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>trying</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=k>lock</span><span class=p>;</span><span class=w> </span><span class=n>try</span><span class=w> </span><span class=n>restarting</span><span class=w> </span><span class=k>transaction</span><span class=w>
</span></span></span></code></pre></div><p>同样发生 <code>Deadlock</code> 。</p><p>为什么在 tx1 获取到表锁后，tx2 进行 insert 再尝试获取表锁时，tx1 再进行 update 会触发 deadlock ?</p><blockquote><p>[!tip]
这里可以理解为什么回滚 tx1：因为 tx2 进行了 insert ，所以比较起来 tx2 比 tx1 大，InnoDB 优先回滚小事务。</p></blockquote><table><thead><tr><th>Tx1</th><th>Tx2</th></tr></thead><tbody><tr><td><code>start transaction;</code></td><td></td></tr><tr><td><code>select * from tb for update;</code></td><td></td></tr><tr><td></td><td><code>start transaction;</code></td></tr><tr><td></td><td><code>insert into tb(_id, id) values (),(),(),();</code> &ndash;> hold primary index lock.</td></tr><tr><td><code>update tb set pid = '123' where id = '01';</code> &ndash;> Deadlock</td><td></td></tr><tr><td></td><td><code>select * from tb for update;</code></td></tr><tr><td></td><td><code>commit;</code></td></tr><tr><td><code>commit;</code></td><td></td></tr></tbody></table><p>如果 <code>update</code> 的语句有索引，比如是 <code>primary key</code>, 那么可以正常使用。
Tx1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Tx2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>tb</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>11</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;12&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>13</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;13&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>14</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;14&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;15&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;16&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>17</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;17&#39;</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>(</span><span class=mi>18</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;18&#39;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>阻塞在 <code>select for update</code>， 等待 Tx1 释放表锁。
Tx1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>update</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pid-123&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>执行成功；这里 <code>_id</code> 是 <code>tb</code> 的 <code>primary key</code>。</p><p>此时 Tx2 获取到 表锁，可以继续往后执行</p><h2 id=参考资料>参考资料</h2><p>MySQL 文档：
1<a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html>InnoDB中不同SQL语句设置的锁</a>
2 <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-model.html>InnoDB Transaction Model</a>
3 <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlocks.html>Deadlocks in InnoDB</a>
4 <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html>InnoDB Locking</a></p><p>以下是关于不同SQL语句设置的锁的摘要内容：</p><p>If you have no indexes suitable for your statement and MySQL must scan the entire table to process the statement, every row of the table becomes locked, which in turn blocks all inserts by other users to the table. It is important to create good indexes so that your queries do not scan more rows than necessary.</p><blockquote><p>如果您没有适合您的语句的索引，并且MySQL必须扫描整个表来处理该语句，则表的每一行都会被锁定，这反过来又会阻止其他用户对表的所有插入。创建良好的索引非常重要，这样您的查询就不会扫描超过必要的行数。</p></blockquote><p>SELECT &mldr; FOR UPDATE sets an exclusive next-key lock on every record the search encounters. However, only an index record lock is required for statements that lock rows using a unique index to search for a unique row. SELECT &mldr; FOR UPDATE</p><blockquote><p>在搜索遇到的每条记录上设置一个独占的下一个键锁。但是，对于使用唯一索引锁定行以搜索唯一行的语句，只需要索引记录锁定。</p></blockquote><p>INSERT sets an exclusive lock on the inserted row. This lock is an index-record lock, not a next-key lock (that is, there is no gap lock) and does not prevent other sessions from inserting into the gap before the inserted row.</p><blockquote><p>INSERT 在插入的行上设置独占锁。此锁是索引记录锁，而不是下一个键锁（即，没有间隙锁），并且不会阻止其他会话插入插入行之前的间隙中。</p></blockquote><p>Prior to inserting the row, a type of gap lock called an insert intention gap lock is set. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6 each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.</p><blockquote><p>在插入行之前，会设置一种称为插入意图间隙锁的间隙锁。此锁定表示插入意图，即插入到同一索引间隙中的多个事务如果未在间隙内的同一位置插入，则无需相互等待。假设存在值为 4 和 7 的索引记录。尝试插入值 5 和 6 的单独事务在获得插入行的独占锁之前，使用插入意图锁锁定 4 和 7 之间的间隙，但不会相互阻塞，因为行是不冲突的。</p></blockquote><p>InnoDB sets an exclusive lock on the end of the index associated with the AUTO_INCREMENT column while initializing a previously specified AUTO_INCREMENT column on a table.</p><blockquote><p>InnoDB 在与 AUTO_INCREMENT 列关联的索引末尾设置独占锁，同时初始化表上以前指定的 AUTO_INCREMENT 列。</p></blockquote><p>With innodb_autoinc_lock_mode=0, InnoDB uses a special AUTO-INC table lock mode where the lock is obtained and held to the end of the current SQL statement (not to the end of the entire transaction) while accessing the auto-increment counter. Other clients cannot insert into the table while the AUTO-INC table lock is held. The same behavior occurs for “bulk inserts” with innodb_autoinc_lock_mode=1. Table-level AUTO-INC locks are not used with innodb_autoinc_lock_mode=2. For more information, See Section 14.6.1.6, “AUTO_INCREMENT Handling in InnoDB”.</p><blockquote><p>InnoDB With innodb_autoinc_lock_mode=0 使用一种特殊的 AUTO-INC 表锁定模式，在访问自动递增计数器时，获取锁并将其保持到当前 SQL 语句的末尾（而不是整个事务的末尾）。当 AUTO-INC 保持表锁时，其他客户端无法插入到表中。对于带有 innodb_autoinc_lock_mode=1 的“批量插入”，也会发生相同的行为。表级 AUTO-INC 锁不与 innodb_autoinc_lock_mode=2 一起使用。有关更多信息，请参见第 14.6.1.6 节“InnoDB 中的AUTO_INCREMENT处理”。</p></blockquote><p>InnoDB fetches the value of a previously initialized AUTO_INCREMENT column without setting any locks.</p><blockquote><p>InnoDB 在不设置任何锁的情况下获取以前初始化 AUTO_INCREMENT 的列的值。</p></blockquote></section><br><p><small>Post on&nbsp;December 6, 2023&nbsp;
·&nbsp;2498 words&nbsp;</small><p><hr><div class=page-nav><a class=page-prev href=https://leo9827.github.io/posts/only-1-imprtant-thing/><i class="fa-solid fa-arrow-left"></i>&nbsp;&nbsp;
<span>最重要的事只有一件</span></a></div></article></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".page-nav");console.log(e.childElementCount);const t=e.firstElementChild.classList.contains("page-next");t?e.classList.add("first-page"):e.classList.remove("first-page");const n=e.childElementCount===1&&e.firstElementChild.classList.contains("page-prev");n?e.classList.add("last-page"):e.classList.remove("last-page")})</script></main><footer><p>&copy; 2024 Personal Site. All rights reserved.</p></footer></body><script></script></html>